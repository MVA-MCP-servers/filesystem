# Улучшенный MCP-сервер файловой системы

Этот файл описывает улучшения, внесенные в MCP-сервер файловой системы для повышения надежности и удобства использования.

## Основные улучшения

В сервер файловой системы были добавлены два ключевых улучшения:

1. **Контекстно-зависимые операции с файлами** - автоматическое определение продолжения работы с файлом
2. **Транзакционный подход к файловым операциям** - повышенная надежность и отказоустойчивость

## 1. Контекстно-зависимые операции

### Проблема
При работе с большими файлами часто требуется разбивать их на части при создании или модификации. Однако для пользователя важно, чтобы система интеллектуально определяла, является ли текущая операция продолжением предыдущей, и выбирала оптимальный способ работы с файлом.

### Решение
- Внедрен менеджер состояний файлов (`FileStateManager`), который отслеживает последние операции с каждым файлом
- Автоматическое определение продолжений операций с файлами (например, когда пользователь пишет "Продолжи")
- Интеллектуальный выбор между `write_file` и `append_file` в зависимости от контекста
- Временное окно в 10 минут для определения продолжения операции

### Пример использования
```typescript
// Если операция является продолжением предыдущей (в пределах временного окна)
if (fileStateManager.isContinuation(filePath)) {
  // Используем append вместо write
  await fileTransactionManager.appendFileTransactionally(filePath, content);
} else {
  // Обычная запись (перезапись файла)
  await fileTransactionManager.writeFileTransactionally(filePath, content);
}
```

## 2. Транзакционный подход

### Проблема
Стандартные операции записи в файл могут привести к потере данных при сбоях или прерываниях:
- Если сбой происходит во время записи, содержимое файла может быть повреждено
- При больших файлах риск ошибок возрастает
- Нет простого способа восстановления данных после сбоя

### Решение
- Введен менеджер транзакций (`FileTransactionManager`) для безопасных операций с файлами
- Запись сначала выполняется во временный файл, затем атомарно перемещается в целевое местоположение
- Создание резервных копий перед перезаписью существующих файлов
- Автоматическое восстановление при ошибках

### Принцип работы транзакций
1. Создание временного файла с уникальным именем
2. Запись данных во временный файл
3. Если целевой файл существует - создание резервной копии
4. Атомарное перемещение временного файла на место целевого
5. При ошибках - автоматическое восстановление из резервной копии
6. Очистка временных файлов

### Пример использования
```typescript
// Безопасная запись в файл с транзакцией
await fileTransactionManager.writeFileTransactionally(filePath, content);

// Безопасное добавление в файл с транзакцией
await fileTransactionManager.appendFileTransactionally(filePath, content);
```

## Другие улучшения

- Улучшенная обработка ошибок и логирование
- Дополнительные параметры для управления транзакциями
- Более безопасное перемещение файлов между разными дисками
- Автоматическая очистка устаревших состояний файлов
- Сохранение отступов при редактировании текстовых файлов

## Установка и использование

1. Создайте резервную копию оригинального кода
2. Скопируйте улучшенный код из `index-improved.ts` в `index.ts`
3. Запустите компиляцию с помощью `npm run build`
4. (Опционально) Используйте скрипт `build-improved.bat` для автоматической компиляции

## Совместимость

Улучшенная версия полностью совместима с оригинальной и поддерживает все существующие инструменты:
- `read_file`, `read_multiple_files`
- `write_file`, `append_file`, `edit_file`
- `create_directory`, `list_directory`, `directory_tree`
- `move_file`, `search_files`, `get_file_info`
- `list_allowed_directories`
